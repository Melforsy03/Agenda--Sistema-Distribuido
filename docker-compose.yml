version: '3.8'

services:
  # ====================================================
  # üéØ COORDINADOR PRINCIPAL
  # ====================================================
  coordinator:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_coordinator:latest
    environment:
      - PYTHONPATH=/app
      - LOG_LEVEL=INFO
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
    ports:
      - "8700:8700"
    networks:
      - raft_network
    volumes:
      - coordinator_data:/app/data
    command: uvicorn distributed.coordinator.router:app --host 0.0.0.0 --port 8700

  # ====================================================
  # üóÇÔ∏è SHARD EVENTOS A-M (3 nodos)
  # ====================================================
  raft_events_am_1:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_raft_node:latest
    environment:
      - PYTHONPATH=/app
      - SHARD_NAME=EVENTOS_A_M
      - NODE_ID=node1
      - PORT=8801
      - PEERS=http://raft_events_am_2:8802,http://raft_events_am_3:8803
    deploy:
      replicas: 1
    ports:
      - "8801:8801"
    networks:
      - raft_network
    volumes:
      - raft_data_1:/app/data
    command: uvicorn distributed.nodes.raft_node:app --host 0.0.0.0 --port 8801
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8801/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  raft_events_am_2:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_raft_node:latest
    environment:
      - PYTHONPATH=/app
      - SHARD_NAME=EVENTOS_A_M
      - NODE_ID=node2
      - PORT=8802
      - PEERS=http://raft_events_am_1:8801,http://raft_events_am_3:8803
    deploy:
      replicas: 1
    ports:
      - "8802:8802"
    networks:
      - raft_network
    volumes:
      - raft_data_2:/app/data
    command: uvicorn distributed.nodes.raft_node:app --host 0.0.0.0 --port 8802
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8802/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  raft_events_am_3:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_raft_node:latest
    environment:
      - PYTHONPATH=/app
      - SHARD_NAME=EVENTOS_A_M
      - NODE_ID=node3
      - PORT=8803
      - PEERS=http://raft_events_am_1:8801,http://raft_events_am_2:8802
    deploy:
      replicas: 1
    ports:
      - "8803:8803"
    networks:
      - raft_network
    volumes:
      - raft_data_3:/app/data
    command: uvicorn distributed.nodes.raft_node:app --host 0.0.0.0 --port 8803
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8803/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ====================================================
  # üóÇÔ∏è SHARD EVENTOS N-Z (3 nodos)
  # ====================================================
  raft_events_nz_1:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_raft_node:latest
    environment:
      - PYTHONPATH=/app
      - SHARD_NAME=EVENTOS_N_Z
      - NODE_ID=node4
      - PORT=8804
      - PEERS=http://raft_events_nz_2:8805,http://raft_events_nz_3:8806
    deploy:
      replicas: 1
    ports:
      - "8804:8804"
    networks:
      - raft_network
    volumes:
      - raft_data_4:/app/data
    command: uvicorn distributed.nodes.raft_node:app --host 0.0.0.0 --port 8804
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8804/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  raft_events_nz_2:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_raft_node:latest
    environment:
      - PYTHONPATH=/app
      - SHARD_NAME=EVENTOS_N_Z
      - NODE_ID=node5
      - PORT=8805
      - PEERS=http://raft_events_nz_1:8804,http://raft_events_nz_3:8806
    deploy:
      replicas: 1
    ports:
      - "8805:8805"
    networks:
      - raft_network
    volumes:
      - raft_data_5:/app/data
    command: uvicorn distributed.nodes.raft_node:app --host 0.0.0.0 --port 8805
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8805/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  raft_events_nz_3:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_raft_node:latest
    environment:
      - PYTHONPATH=/app
      - SHARD_NAME=EVENTOS_N_Z
      - NODE_ID=node6
      - PORT=8806
      - PEERS=http://raft_events_nz_1:8804,http://raft_events_nz_2:8805
    deploy:
      replicas: 1
    ports:
      - "8806:8806"
    networks:
      - raft_network
    volumes:
      - raft_data_6:/app/data
    command: uvicorn distributed.nodes.raft_node:app --host 0.0.0.0 --port 8806
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8806/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ====================================================
  # üóÇÔ∏è SHARD GRUPOS (3 nodos)
  # ====================================================
  raft_groups_1:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_raft_node:latest
    environment:
      - PYTHONPATH=/app
      - SHARD_NAME=GRUPOS
      - NODE_ID=node7
      - PORT=8807
      - PEERS=http://raft_groups_2:8808,http://raft_groups_3:8809
    deploy:
      replicas: 1
    ports:
      - "8807:8807"
    networks:
      - raft_network
    volumes:
      - raft_data_7:/app/data
    command: uvicorn distributed.nodes.raft_node:app --host 0.0.0.0 --port 8807
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8807/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  raft_groups_2:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_raft_node:latest
    environment:
      - PYTHONPATH=/app
      - SHARD_NAME=GRUPOS
      - NODE_ID=node8
      - PORT=8808
      - PEERS=http://raft_groups_1:8807,http://raft_groups_3:8809
    deploy:
      replicas: 1
    ports:
      - "8808:8808"
    networks:
      - raft_network
    volumes:
      - raft_data_8:/app/data
    command: uvicorn distributed.nodes.raft_node:app --host 0.0.0.0 --port 8808
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8808/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  raft_groups_3:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_raft_node:latest
    environment:
      - PYTHONPATH=/app
      - SHARD_NAME=GRUPOS
      - NODE_ID=node9
      - PORT=8809
      - PEERS=http://raft_groups_1:8807,http://raft_groups_2:8808
    deploy:
      replicas: 1
    ports:
      - "8809:8809"
    networks:
      - raft_network
    volumes:
      - raft_data_9:/app/data
    command: uvicorn distributed.nodes.raft_node:app --host 0.0.0.0 --port 8809
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8809/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ====================================================
  # üóÇÔ∏è SHARD USUARIOS (3 nodos)
  # ====================================================
  raft_users_1:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_raft_node:latest
    environment:
      - PYTHONPATH=/app
      - SHARD_NAME=USUARIOS
      - NODE_ID=node10
      - PORT=8810
      - PEERS=http://raft_users_2:8811,http://raft_users_3:8812
    deploy:
      replicas: 1
    ports:
      - "8810:8810"
    networks:
      - raft_network
    volumes:
      - raft_data_10:/app/data
    command: uvicorn distributed.nodes.raft_node:app --host 0.0.0.0 --port 8810
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8810/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  raft_users_2:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_raft_node:latest
    environment:
      - PYTHONPATH=/app
      - SHARD_NAME=USUARIOS
      - NODE_ID=node11
      - PORT=8811
      - PEERS=http://raft_users_1:8810,http://raft_users_3:8812
    deploy:
      replicas: 1
    ports:
      - "8811:8811"
    networks:
      - raft_network
    volumes:
      - raft_data_11:/app/data
    command: uvicorn distributed.nodes.raft_node:app --host 0.0.0.0 --port 8811
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8811/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  raft_users_3:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: agenda_raft_node:latest
    environment:
      - PYTHONPATH=/app
      - SHARD_NAME=USUARIOS
      - NODE_ID=node12
      - PORT=8812
      - PEERS=http://raft_users_1:8810,http://raft_users_2:8811
    deploy:
      replicas: 1
    ports:
      - "8812:8812"
    networks:
      - raft_network
    volumes:
      - raft_data_12:/app/data
    command: uvicorn distributed.nodes.raft_node:app --host 0.0.0.0 --port 8812
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8812/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ====================================================
  # üñ•Ô∏è FRONTEND (Streamlit)
  # ====================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    image: agenda_frontend:latest
    environment:
      - PYTHONPATH=/app
      - API_URL=http://coordinator:8700
    deploy:
      replicas: 1
    ports:
      - "8501:8501"
    networks:
      - raft_network
    depends_on:
      - coordinator
    command: streamlit run front/app.py --server.port=8501 --server.address=0.0.0.0

networks:
  raft_network:
    driver: overlay
    attachable: true

volumes:
  coordinator_data:
  raft_data_1:
  raft_data_2:
  raft_data_3:
  raft_data_4:
  raft_data_5:
  raft_data_6:
  raft_data_7:
  raft_data_8:
  raft_data_9:
  raft_data_10:
  raft_data_11:
  raft_data_12: